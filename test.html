<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi·∫øt b·ªã 2FA ‚Äì B·ªô ƒë·∫øm th·ªùi gian (B·∫£n t·ªëi ∆∞u cu·ªëi)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Changa:wght@700&family=Orbitron:wght@900&display=swap" rel="stylesheet">

    <style>
        /* Gi·ªØ nguy√™n to√†n b·ªô CSS */
        :root {
            --bg-color: #3d352a; --container-bg: rgba(20, 15, 10, 0.85);
            --text-color: #e8e6e3; --primary-color: #d32f2f; --primary-hover: #f44336;
            --border-color: rgba(211, 47, 47, 0.4); --input-bg: rgba(0,0,0, 0.2);
            --fuse-color: #6b4f3b; --dynamite-red: #b71c1c; --dynamite-dark-red: #8a1111;
            --timer-glow: #ff1744;
        }
        body {
            font-family: 'Changa', 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
            color: var(--text-color); margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .container { width: 100%; max-width: 600px; background-color: var(--container-bg); border-radius: 4px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4); overflow: hidden; backdrop-filter: blur(4px);}
        .header { padding: 16px 24px; background-color: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-color); text-align: center;}
        .header h1 { margin: 0; font-size: 24px; text-transform: uppercase; letter-spacing: 2px; }
        .content { padding: 24px; }
        .account-list { display: flex; flex-direction: column; gap: 20px; min-height: 50px; }
        /* C√°c ph·∫ßn CSS kh√°c gi·ªØ nguy√™n */
    </style>
</head>

<body>
    <div class="container">
        <div class="header"><h1>B·∫£ng ƒëi·ªÅu khi·ªÉn thi·∫øt b·ªã</h1></div>
        <div class="content">

            <p id="empty-state" style="text-align: center; color: #eee; padding: 20px 0;">
                Kh√¥ng c√≥ thi·∫øt b·ªã n√†o. Vui l√≤ng th√™m ho·∫∑c nh·∫≠p d·ªØ li·ªáu.
            </p>

            <div id="account-list"></div>

            <div id="add-account-form">
                <h2>ƒêƒÉng k√Ω thi·∫øt b·ªã m·ªõi</h2>

                <form id="add-form">
                    <div class="form-group">
                        <label for="account-name-input">T√™n thi·∫øt b·ªã</label>
                        <input type="text" id="account-name-input" required>
                    </div>

                    <div class="form-group">
                        <label for="account-secret-input">Kh√≥a k√≠ch ho·∫°t</label>
                        <input type="text" id="account-secret-input" required>
                    </div>

                    <button type="submit" class="btn-submit">X√°c nh·∫≠n k√≠ch ho·∫°t</button>
                </form>
            </div>

            <div class="control-panel">
                <div class="warning-box">
                    <strong>C·∫£nh b√°o!</strong> Tuy·ªát ƒë·ªëi kh√¥ng t·∫£i l·∫°i trang, n·∫øu kh√¥ng to√†n b·ªô d·ªØ li·ªáu ch∆∞a xu·∫•t s·∫Ω b·ªã m·∫•t.
                </div>

                <div class="panel-buttons">
                    <button id="import-btn">Nh·∫≠p d·ªØ li·ªáu</button>
                    <input type="file" id="file-input" accept=".json" style="display:none;">
                    <button id="export-btn">Xu·∫•t d·ªØ li·ªáu</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast"
        style="position: fixed; bottom: -50px; left: 50%; transform: translateX(-50%);
        background-color: rgba(0,0,0,0.8); border: 1px solid #f3ca39; color: #f3ca39;
        padding: 10px 20px; border-radius: 2px; opacity: 0;
        transition: opacity 0.3s, bottom 0.3s; z-index: 1000;">
    </div>


    <script>
        // --- Gi·ªØ nguy√™n to√†n b·ªô logic, ch·ªâ d·ªãch text ---
        document.addEventListener('DOMContentLoaded', () => {
            const DOM = {
                accountList: document.getElementById('account-list'),
                emptyState: document.getElementById('empty-state'),
                addForm: document.getElementById('add-form'),
                importBtn: document.getElementById('import-btn'),
                fileInput: document.getElementById('file-input'),
                exportBtn: document.getElementById('export-btn'),
                toast: document.getElementById('toast'),
                accountNameInput: document.getElementById('account-name-input'),
                accountSecretInput: document.getElementById('account-secret-input')
            };

            let accounts = [];
            let updateInterval = null;
            let accountDOMElements = [];

            function base32Decode(base32Str) {
                const b="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
                const s=String(base32Str).replace(/[\s=]/g,"").toUpperCase();
                let t="";
                for(let i=0;i<s.length;i++){
                    const c=s.charAt(i);
                    const v=b.indexOf(c);
                    if(v===-1)throw new Error(`Kh√≥a ch·ª©a k√Ω t·ª± kh√¥ng h·ª£p l·ªá: "${c}"`);
                    t+=v.toString(2).padStart(5,'0')
                }
                let r="";
                for(let i=0;i+8<=t.length;i+=8){
                    r+=parseInt(t.substr(i,8),2).toString(16).padStart(2,'0')
                }
                if(!r)throw new Error("Kh√≥a qu√° ng·∫Øn ho·∫∑c sai ƒë·ªãnh d·∫°ng");
                return r;
            }

            async function generateTOTP(secret, crypto) {
                const h=base32Decode(secret);
                const b=h.match(/[\da-f]{2}/gi);
                if(!b)throw new Error("Byte kh√¥ng h·ª£p l·ªá");
                const k=new Uint8Array(b.map(h=>parseInt(h,16)));

                const e=Math.floor(Date.now()/1000.0);
                let t=Math.floor(e/30);
                const y=new Uint8Array(8);
                for(let i=7;i>=0;i--){y[i]=t&0xff;t>>=8}

                const i=await crypto.subtle.importKey('raw',k,{name:'HMAC',hash:'SHA-1'},!1,['sign']);
                const m=await crypto.subtle.sign('HMAC',i,y);
                const a=new Uint8Array(m);
                const o=a[a.length-1]&0x0f;

                const c=(((a[o]&0x7f)<<24)|((a[o+1]&0xff)<<16)|((a[o+2]&0xff)<<8)|(a[o+3]&0xff))%1000000;
                return c.toString().padStart(6,'0');
            }

            function showToast(message) {
                DOM.toast.textContent=message;
                DOM.toast.style.bottom='20px';
                DOM.toast.style.opacity='1';
                setTimeout(() => {
                    DOM.toast.style.bottom='-50px';
                    DOM.toast.style.opacity='0';
                }, 2000);
            }

            function escapeHTML(str) {
                const p=document.createElement('p');
                p.textContent=str;
                return p.innerHTML;
            }

            async function updateDisplay() {
                if(accounts.length===0)return;

                const s=new Date().getSeconds()%30;
                const p=((30-s)/30)*100;
                const t=s===0?'none':'width 1s linear';

                for(let i=0;i<accounts.length;i++) {
                    const e=accountDOMElements[i];
                    if(!e)continue;

                    if(s===0){
                        e.itemEl.classList.add('exploding');
                        setTimeout(() => {e.itemEl.classList.remove('exploding');}, 1000);
                    }

                    const c=await generateTOTP(accounts[i].secret,window.crypto);
                    if(e.codeEl.textContent!==c){e.codeEl.textContent=c;}

                    e.progressEl.style.transition=t;
                    e.progressEl.style.width=`${p}%`;
                }
            }

            function fullRender() {
                DOM.accountList.innerHTML='';
                accountDOMElements=[];

                if(accounts.length===0){
                    DOM.emptyState.style.display='block';
                    return;
                } 
                DOM.emptyState.style.display='none';

                accounts.forEach((a, i) => {
                    const t=document.createElement('div');
                    t.className='account-item';

                    t.innerHTML=`
                        <div class="account-info">
                            <div class="account-name">${escapeHTML(a.name)}</div>
                            <div class="timer-display"><span class="account-code">......</span></div>
                            <div class="fuse-container">
                                <div class="lit-fuse-icon">üî•</div>
                                <div class="progress-bar">
                                    <div class="progress-bar-inner"></div>
                                </div>
                            </div>
                        </div>

                        <div class="account-actions">
                            <button class="action-button copy-btn" title="Sao ch√©p">üìã</button>
                            <button class="action-button delete-btn" title="X√≥a">üóëÔ∏è</button>
                        </div>
                    `;

                    t.querySelector('.copy-btn').addEventListener('click', () => {
                        navigator.clipboard.writeText(t.querySelector('.account-code').textContent);
                        showToast('ƒê√£ sao ch√©p m√£!');
                    });

                    t.querySelector('.delete-btn').addEventListener('click', () => {
                        if(confirm(`X√°c nh·∫≠n x√≥a thi·∫øt b·ªã "${escapeHTML(a.name)}"?`)){
                            accounts.splice(i,1);
                            fullRender();
                        }
                    });

                    DOM.accountList.appendChild(t);

                    accountDOMElements.push({
                        itemEl: t,
                        codeEl: t.querySelector('.account-code'),
                        progressEl: t.querySelector('.progress-bar-inner')
                    });
                });

                updateDisplay();
            }

            function startUpdater() {
                if(updateInterval)clearInterval(updateInterval);
                fullRender();
                updateInterval=setInterval(updateDisplay,1000);
            }

            DOM.addForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const n=DOM.accountNameInput.value.trim();
                const s=DOM.accountSecretInput.value.trim();

                if(!n||!s){
                    alert('T√™n thi·∫øt b·ªã v√† kh√≥a k√≠ch ho·∫°t kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.');
                    return;
                }

                try {
                    await generateTOTP(s,window.crypto);
                    accounts.push({name:n,secret:s});
                    DOM.accountNameInput.value='';
                    DOM.accountSecretInput.value='';
                    fullRender();
                } catch(err) {
                    alert(`K√≠ch ho·∫°t th·∫•t b·∫°i: Kh√≥a kh√¥ng h·ª£p l·ªá.\n\nChi ti·∫øt: ${err.message}`);
                }
            });

            DOM.importBtn.addEventListener('click', ()=>DOM.fileInput.click());

            DOM.fileInput.addEventListener('change', (e) => {
                const f=e.target.files[0];
                if(!f)return;

                const r=new FileReader();
                r.onload=async(e)=>{
                    try{
                        const d=JSON.parse(e.target.result);
                        if(!Array.isArray(d))throw new Error();

                        const v=[];
                        for(const i of d){
                            if(i.name && i.secret){
                                try{
                                    await generateTOTP(i.secret,window.crypto);
                                    v.push(i);
                                }catch(e){
                                    console.warn("B·ªè qua kh√≥a kh√¥ng h·ª£p l·ªá:", i.name);
                                }
                            }
                        }

                        accounts=v;
                        fullRender();
                        showToast(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${v.length} thi·∫øt b·ªã.`);
                    }catch(err){
                        alert('Nh·∫≠p d·ªØ li·ªáu th·∫•t b·∫°i: File sai ƒë·ªãnh d·∫°ng.');
                    }
                };

                r.readAsText(f);
                e.target.value='';
            });

            DOM.exportBtn.addEventListener('click', () => {
                if(accounts.length===0){
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
                    return;
                }

                const d=JSON.stringify(accounts,null,2);
                const b=new Blob([d],{type:'application/json'});
                const u=URL.createObjectURL(b);

                const l=document.createElement('a');
                l.href=u;
                l.download=`2fa-backup-${new Date().toISOString().slice(0,10)}.json`;
                l.click();

                URL.revokeObjectURL(u);
                showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu.');
            });

            startUpdater();
        });
    </script>
</body>
</html>
